<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>分布式能源交易系统</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --accent: #4895ef;
        --success: #4cc9f0;
        --energy-green: #2ecc71;
        --energy-yellow: #f39c12;
        --energy-blue: #3498db;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --danger: #e63946;
        --border-radius: 12px;
        --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: var(--dark);
        padding-top: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
      }

      .header h1 {
        font-size: 2.5rem;
        color: var(--primary);
        margin-bottom: 10px;
      }

      .header p {
        color: var(--gray);
        font-size: 1.1rem;
        max-width: 800px;
        margin: 0 auto;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .card {
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        border: none;
        margin-bottom: 20px;
        transition: var(--transition);
        background: white;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card-header {
        background: linear-gradient(to right, var(--primary), var(--accent));
        color: white;
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
        border-bottom: none;
        font-weight: 600;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card-body {
        padding: 20px;
      }

      .section-title {
        color: var(--primary);
        border-left: 4px solid var(--accent);
        padding-left: 15px;
        margin: 25px 0 15px;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .energy-grid {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: linear-gradient(
            rgba(67, 97, 238, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(67, 97, 238, 0.03) 1px, transparent 1px);
        background-size: 30px 30px;
        z-index: -1;
        opacity: 0.5;
      }

      .btn {
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(to right, var(--primary), var(--accent));
        color: white;
      }

      .btn-success {
        background: linear-gradient(to right, var(--energy-green), #27ae60);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(to right, var(--energy-yellow), #e67e22);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(to right, var(--danger), #c0392b);
        color: white;
      }

      .btn-outline {
        background: transparent;
        border: 2px solid var(--gray);
        color: var(--gray);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e1e5eb;
        border-radius: 8px;
        font-size: 16px;
        transition: var(--transition);
        outline: none;
      }

      .form-control:disabled {
        background-color: #f8f9fa;
        cursor: not-allowed;
      }

      .form-control:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      }

      .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.85rem;
        display: inline-block;
      }

      .status-created {
        background-color: rgba(52, 152, 219, 0.2);
        color: var(--energy-blue);
      }

      .status-matched {
        background-color: rgba(243, 156, 18, 0.2);
        color: var(--energy-yellow);
      }

      .status-finished {
        background-color: rgba(46, 204, 113, 0.2);
        color: var(--energy-green);
      }

      .user-card {
        background: linear-gradient(135deg, #ffffff 0%, #f7fff0 100%);
        border-left: 4px solid var(--energy-green);
      }

      .order-card {
        background: linear-gradient(135deg, #ffffff 0%, #fff5f0 100%);
        border-left: 4px solid var(--energy-yellow);
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        text-align: center;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        color: white;
      }

      .stat-card i {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.8;
      }

      .stat-card .number {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 10px 0;
      }

      .stat-card .label {
        font-size: 1rem;
        opacity: 0.9;
      }

      .message {
        padding: 12px;
        border-radius: 8px;
        margin: 15px 0;
        font-size: 14px;
      }

      .error-message {
        background-color: rgba(230, 57, 70, 0.1);
        color: var(--danger);
      }

      .success-message {
        background-color: rgba(76, 201, 240, 0.1);
        color: var(--success);
      }

      .order-table {
        width: 100%;
        border-collapse: collapse;
      }

      .order-table th,
      .order-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e1e5eb;
      }

      .order-table th {
        background-color: #f8f9fa;
        font-weight: 600;
      }

      .order-table tr:hover {
        background-color: #f8f9fa;
      }

      .action-cell {
        display: flex;
        gap: 8px;
      }

      .user-info-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .user-info-panel {
          grid-template-columns: 1fr;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
        }
      }

      .energy-icon {
        background: rgba(67, 97, 238, 0.1);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: var(--primary);
        font-size: 1.5rem;
      }

      .nav-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e1e5eb;
        padding-bottom: 10px;
      }

      .nav-tab {
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 500;
      }

      .nav-tab.active {
        background: var(--primary);
        color: white;
      }

      .nav-tab:hover:not(.active) {
        background: #e1e5eb;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      /* 弹窗样式 - 优化版本 */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(3px);
        transition: all 0.3s ease;
      }

      .modal-content {
        background-color: white;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        transform: translateY(-30px);
        opacity: 0;
        transition: all 0.3s ease;
      }

      .modal.active .modal-content {
        transform: translateY(0);
        opacity: 1;
      }

      .modal-header {
        background: linear-gradient(to right, var(--primary), var(--accent));
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
      }

      .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        opacity: 0.8;
      }

      .close:hover {
        opacity: 1;
        transform: scale(1.1);
      }

      .modal-body {
        padding: 25px;
      }

      .modal-text {
        line-height: 1.8;
        font-size: 1rem;
      }

      .modal-text strong {
        color: var(--primary);
        min-width: 100px;
        display: inline-block;
      }

      .modal-text div {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
      }

      .modal-text div:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .modal-footer {
        padding: 15px 25px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
      }

      .modal-btn {
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        border: none;
        background: linear-gradient(to right, var(--primary), var(--accent));
        color: white;
      }

      .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
      }

      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(67, 97, 238, 0.2);
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 新增样式：创建订单界面优化 */
      .create-order-section .card {
        background: linear-gradient(135deg, #ffffff 0%, #f0f5ff 100%);
        border-left: 4px solid var(--energy-blue);
      }

      .form-range {
        width: 100%;
        height: 10px;
        border-radius: 5px;
        background: #e1e5eb;
        outline: none;
        transition: var(--transition);
      }

      .form-range:focus {
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
      }

      .form-range::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        transition: var(--transition);
      }

      .form-range::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
      }

      .input-group {
        display: flex;
        margin-top: 10px;
      }

      .input-group-text {
        display: flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #495057;
        text-align: center;
        white-space: nowrap;
        background-color: #e9ecef;
        border: 2px solid #e1e5eb;
        border-radius: 8px;
        border-left: none;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
      }

      .input-group input {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        border-right: none;
      }

      .order-summary {
        background: linear-gradient(135deg, #ffffff 0%, #f9f9f9 100%);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      }

      .order-summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px dashed #e1e5eb;
      }

      .order-summary-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .order-summary-total {
        font-weight: 600;
        font-size: 1.1rem;
      }

      .order-profit {
        font-weight: 700;
        font-size: 1.4rem;
        color: var(--energy-green);
      }

      .order-type-indicator {
        display: flex;
        align-items: center;
        padding: 15px;
        background: rgba(67, 97, 238, 0.1);
        border-radius: var(--border-radius);
        margin-bottom: 20px;
      }

      .order-type-indicator i {
        font-size: 1.5rem;
        color: var(--primary);
        margin-right: 10px;
      }

      .price-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 5px;
      }

      .price-hint {
        font-size: 0.85rem;
        color: var(--gray);
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="energy-grid"></div>

    <div class="header">
      <h1><i class="fas fa-bolt"></i> 分布式能源交易系统</h1>
      <p>去中心化能源交易平台，实现能源生产者与消费者的直接交易</p>
    </div>

    <div class="container">
      <!-- 导航标签 -->
      <div class="nav-tabs">
        <div class="nav-tab active" data-tab="dashboard">仪表盘</div>
        <div class="nav-tab" data-tab="orders">订单管理</div>
        <div class="nav-tab" data-tab="create-order">创建订单</div>
        <div class="nav-tab" data-tab="user-info">系统状态</div>
      </div>

      <!-- 仪表盘界面 -->
      <div class="tab-content active" id="dashboard-section">
        <h2 class="section-title">
          <i class="fas fa-tachometer-alt"></i> 能源交易仪表盘
        </h2>

        <div class="dashboard-grid">
          <div
            class="stat-card"
            style="
              background: linear-gradient(135deg, var(--energy-blue), #2980b9);
            "
            id="energy-price-card"
          >
            <i class="fas fa-chart-line"></i>
            <div class="number" id="energy-price">¥1.25</div>
            <div class="label">当前能源价格</div>
          </div>
          <div
            class="stat-card"
            style="
              background: linear-gradient(135deg, var(--energy-green), #27ae60);
            "
            id="active-user-card"
          >
            <i class="fas fa-exchange-alt"></i>
            <div class="number" id="active-orders">24</div>
            <div class="label">活跃交易订单</div>
          </div>
          <div
            class="stat-card"
            style="
              background: linear-gradient(
                135deg,
                var(--energy-yellow),
                #e67e22
              );
            "
            id="active-order-card"
          >
            <i class="fas fa-users"></i>
            <div class="number" id="active-users">18</div>
            <div class="label">活跃用户</div>
          </div>
        </div>

        <h3 class="section-title"><i class="fas fa-list"></i> 最新交易订单</h3>
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="order-table">
                <thead>
                  <tr>
                    <th>订单ID</th>
                    <th>数量 (kWh)</th>
                    <th>状态</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="orders-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 优化后的弹窗 -->
      <div id="orderDetailModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2><i class="fas fa-file-invoice"></i> 订单详情</h2>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <div id="modalText" class="modal-text">
              <div class="loading-spinner">
                <div class="spinner"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <!-- 按钮将根据订单状态动态添加 -->
            <div id="actionButtons"></div>
            <button class="modal-btn" id="closeModalBtn">关闭</button>
          </div>
        </div>
      </div>

      <!-- 订单管理界面 -->
      <div class="tab-content" id="orders-section">
        <h2 class="section-title">
          <i class="fas fa-exchange-alt"></i> 订单管理
        </h2>

        <div class="card">
          <div class="card-header"><i class="fas fa-filter"></i> 筛选条件</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">订单状态</label>
                <select class="form-control" id="order-status-filter">
                  <option value="ALL">全部状态</option>
                  <option value="CREATED">已创建</option>
                  <option value="MATCHED">已匹配</option>
                  <option value="FINISHED">已完成</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">订单类型</label>
                <select class="form-control" id="order-type-filter">
                  <option value="ALL">全部类型</option>
                  <option value="MINE">我的订单</option>
                </select>
              </div>
              <div class="col-md-4 mb-3 d-flex align-items-end">
                <button class="btn btn-primary w-100" id="apply-filter-btn">
                  <i class="fas fa-filter me-2"></i>应用筛选
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <div><i class="fas fa-list me-2"></i> 订单列表</div>
            <button
              class="btn btn-sm btn-outline-primary"
              id="refresh-orders-btn"
            >
              <i class="fas fa-sync-alt"></i> 刷新
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="order-table">
                <thead>
                  <tr>
                    <th>订单ID</th>
                    <th>数量 (kWh)</th>
                    <th>状态</th>
                    <th>创建时间</th>
                  </tr>
                </thead>
                <tbody id="all-orders-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 创建订单界面 -->
      <div class="tab-content create-order-section" id="create-order-section">
        <h2 class="section-title">
          <i class="fas fa-plus-circle"></i> 创建新订单
        </h2>

        <div class="card">
          <div class="card-header">
            <i class="fas fa-file-invoice"></i> 订单信息
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <!-- 交易类型指示器（只显示出售能源） -->
                <div class="order-type-indicator">
                  <i class="fas fa-solar-panel"></i>
                  <div>
                    <h4>出售能源</h4>
                    <p class="mb-0">您正在创建出售能源的订单</p>
                  </div>
                </div>

                <div class="mb-4">
                  <label for="order-amount" class="form-label"
                    >能源数量 (kWh)</label
                  >
                  <input
                    type="range"
                    class="form-range"
                    min="1"
                    max="300"
                    id="order-amount-range"
                    value="100"
                  />
                  <div class="input-group mt-2">
                    <input
                      type="number"
                      class="form-control"
                      id="order-amount"
                      value="100"
                      min="1"
                      max="300"
                    />
                    <span class="input-group-text">kWh</span>
                  </div>
                </div>

                <div class="mb-3">
                  <div class="price-label">
                    <label for="order-price" class="form-label"
                      >能源单价 (¥/kWh)</label
                    >
                    <span class="price-hint" id="market-price-indicator"
                      >市场价: ¥1.25</span
                    >
                  </div>
                  <div class="input-group">
                    <span class="input-group-text">¥</span>
                    <input
                      type="number"
                      class="form-control"
                      id="order-price"
                      value="1.25"
                      min="0.1"
                      step="0.01"
                      disabled
                    />
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-4">
                  <label class="form-label">订单详情</label>
                  <div class="order-summary">
                    <div class="order-summary-item">
                      <span>能源单价:</span>
                      <span id="order-price-display">¥1.25</span>
                    </div>
                    <div class="order-summary-item">
                      <span>交易费用 (1%):</span>
                      <span id="order-fee">¥1.25</span>
                    </div>
                    <div class="order-summary-item">
                      <span>总金额:</span>
                      <span id="order-total">¥126.25</span>
                    </div>
                    <div class="order-summary-item order-summary-total">
                      <span>预计收益:</span>
                      <span class="order-profit" id="order-profit"
                        >¥126.25</span
                      >
                    </div>
                  </div>
                </div>

                <button
                  class="btn btn-primary w-100 btn-lg"
                  id="create-order-btn"
                >
                  <i class="fas fa-check-circle me-2"></i>创建订单
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 系统状态界面 -->
      <div class="tab-content" id="user-info-section">
        <h2 class="section-title"><i class="fas fa-chart-bar"></i> 系统状态</h2>

        <div class="card">
          <div class="card-header"><i class="fas fa-cogs"></i> 系统概览</div>
          <div class="card-body user-card">
            <div class="user-info-panel">
              <div>
                <div class="d-flex align-items-center mb-4">
                  <div class="energy-icon">
                    <i class="fas fa-bolt"></i>
                  </div>
                  <div>
                    <h4>分布式能源交易平台</h4>
                    <p class="text-muted mb-0">版本 2.1.0 | 运行中</p>
                  </div>
                </div>

                <div class="mb-3">
                  <h5><i class="fas fa-server me-2"></i> 系统信息</h5>
                  <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                      <span>当前用户数:</span>
                      <span>18</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>活跃订单数:</span>
                      <span>24</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>今日交易量:</span>
                      <span>1,250.5 kWh</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>系统运行时间:</span>
                      <span>15天 8小时 42分</span>
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <h5><i class="fas fa-chart-pie me-2"></i> 能源统计</h5>
                <div class="mt-4">
                  <div class="d-flex justify-content-between mb-2">
                    <span>总能源产量:</span>
                    <span>15,250.5 kWh</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>总能源消耗:</span>
                    <span>12,800.2 kWh</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>交易成功率:</span>
                    <span>92.5%</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>平均交易时间:</span>
                    <span>28分钟</span>
                  </div>
                </div>

                <div class="mt-4">
                  <button
                    class="btn btn-outline-primary w-100"
                    id="refresh-system-btn"
                  >
                    <i class="fas fa-sync-alt me-2"></i> 刷新系统状态
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h3 class="section-title mt-4">
          <i class="fas fa-plug"></i> 能源市场数据
        </h3>
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header">能源价格趋势</div>
                  <div class="card-body">
                    <canvas id="price-chart" height="250"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">能源类型分布</div>
                  <div class="card-body">
                    <canvas id="energy-type-chart" height="250"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const API_BASE_URL = "http://localhost:8080";

      const modal = document.getElementById("orderDetailModal");
      const closeBtn = document.querySelector(".close");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const modalText = document.getElementById("modalText");

      // 初始化页面
      document.addEventListener("DOMContentLoaded", function () {
        // 绑定事件
        bindEvents();

        updatecardData();
        loadAllOrders();

        // 初始化图表
        initCharts();

        // 初始化订单金额计算
        updateOrderDetails();
      });

      // 绑定事件
      function bindEvents() {
        // 绑定弹窗关闭事件
        closeBtn.addEventListener("click", closeModal);
        closeModalBtn.addEventListener("click", closeModal);
        // 导航标签点击
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            const tabId = this.getAttribute("data-tab");
            showTab(tabId);

            // 更新活动状态
            document.querySelectorAll(".nav-tab").forEach((el) => {
              el.classList.remove("active");
            });
            this.classList.add("active");
          });
        });

        // 能源数量滑块
        const amountRange = document.getElementById("order-amount-range");
        const amountInput = document.getElementById("order-amount");

        amountRange.addEventListener("input", function () {
          amountInput.value = this.value;
          updateOrderDetails();
        });

        amountInput.addEventListener("input", function () {
          let value = parseInt(this.value);
          if (value < 1) value = 1;
          if (value > 1000) value = 1000;
          this.value = value;
          amountRange.value = value;
          updateOrderDetails();
        });

        // 创建订单按钮
        document
          .getElementById("create-order-btn")
          .addEventListener("click", createOrder);

        // 刷新系统状态按钮
        document
          .getElementById("refresh-system-btn")
          .addEventListener("click", refreshSystem);

        // 刷新订单按钮
        document
          .getElementById("refresh-orders-btn")
          .addEventListener("click", loadAllOrders);

        // 应用筛选按钮
        document
          .getElementById("apply-filter-btn")
          .addEventListener("click", loadAllOrders);

        // 查看订单详情
        document.querySelectorAll("[data-order-id]").forEach((btn) => {
          btn.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            showOrderDetail(orderId);
          });
        });

        // 仪表盘energy-price-card
        document
          .getElementById("energy-price-card")
          .addEventListener("click", () => {
            updatecardData(); // 点击更新当前能源价格
          });
        // 仪表盘active-user-card
        document
          .getElementById("active-user-card")
          .addEventListener("click", () => {
            updatecardData(); // 点击更新当前能源价格
          });
        // 仪表盘active-order-card
        document
          .getElementById("active-order-card")
          .addEventListener("click", () => {
            updatecardData(); // 点击更新当前能源价格
          });

        document.querySelectorAll("[data-order-id]").forEach((btn) => {
          btn.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            showOrderDetail(orderId);
          });
        });
      }

      // 更新 showOrderDetail 函数，正确使用 API 数据
      function showOrderDetail(orderId) {
        // 显示模态框和加载状态
        modal.style.display = "flex";
        setTimeout(() => {
          modal.classList.add("active");
        }, 10);

        modalText.innerHTML = `
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: var(--gray);">正在加载订单数据...</p>
      </div>
    `;

        // 使用真实 API 数据
        fetch(`${API_BASE_URL}/getorder/${orderId}`)
          .then((response) => response.json())
          .then((data) => {
            // 转换状态为中文
            const statusMap = {
              CREATED: "已创建",
              MATCHED: "已匹配",
              FINISHED: "已完成",
            };

            const orderData = {
              id: data.id,
              partyA: data.partyA,
              partyB: data.partyB || "等待匹配中...",
              amount: data.amount,
              status: statusMap[data.status] || data.status,
              price: data.price,
              createdat: data.createdAt,
            };

            updateModalContent(orderData);
          })
          .catch(function (error) {
            modalText.innerHTML = `<div class="error-message">请求失败，请稍后再试。</div>`;
            console.error("获取订单详情失败:", error);
          });
      }

      // 更新 updateModalContent 函数，添加按钮
      function updateModalContent(data) {
        const statusClass =
          {
            已创建: "status-created",
            已匹配: "status-matched",
            已完成: "status-finished",
          }[data.status] || "status-created";

        modalText.innerHTML = `
      <div>
        <strong>订单ID:</strong> ${data.id}
      </div>
      <div>
        <strong>卖方:</strong> ${data.partyA}
      </div>
      <div>
        <strong>买方:</strong> ${data.partyB}
      </div>
      <div>
        <strong>数量:</strong> ${data.amount} kWh
      </div>
      <div>
        <strong>状态:</strong> <span class="status-badge ${statusClass}">${
          data.status
        }</span>
      </div>
      <div>
        <strong>单价:</strong> ¥${data.price}/kWh
      </div>
      <div>
        <strong>创建时间:</strong> ${data.createdat}
      </div>
      <div>
        <strong>总金额:</strong> ¥${(data.amount * data.price).toFixed(2)}
      </div>
    `;

        // 根据状态添加操作按钮
        const actionButtons = document.getElementById("actionButtons");
        actionButtons.innerHTML = ""; // 清空之前的按钮

        if (data.status === "已创建") {
          const matchButton = document.createElement("button");
          matchButton.className = "modal-btn";
          matchButton.style.background =
            "linear-gradient(to right, var(--energy-yellow), #e67e22";
          matchButton.style.marginRight = "10px";
          matchButton.innerHTML = '<i class="fas fa-handshake"></i> 匹配';
          matchButton.onclick = () => matchOrder(data.id);
          actionButtons.appendChild(matchButton);
        } else if (data.status === "已匹配") {
          const tradeButton = document.createElement("button");
          tradeButton.className = "modal-btn";
          tradeButton.style.background =
            "linear-gradient(to right, var(--energy-green), #27ae60)";
          tradeButton.style.marginRight = "10px";
          tradeButton.innerHTML = '<i class="fas fa-exchange-alt"></i> 交易';
          tradeButton.onclick = () => tradeOrder(data.id);
          actionButtons.appendChild(tradeButton);
        }
      }

      // 匹配订单函数
      function matchOrder(orderId) {
        const actionButtons = document.getElementById("actionButtons");
        actionButtons.innerHTML =
          '<button class="modal-btn" style="background: linear-gradient(to right, var(--energy-yellow), #e67e22); margin-right: 10px;"><i class="fas fa-spinner fa-spin"></i> 匹配中...</button>';

        fetch(`${API_BASE_URL}/matchorder/${orderId}`)
          .then((response) => response.json())
          .then((data) => {
              // 更新UI显示匹配成功
              const statusBadge = document.querySelector(
                ".modal-text .status-badge"
              );
              if (statusBadge) {
                statusBadge.textContent = "已匹配";
                statusBadge.className = "status-badge status-matched";
              }

              // 刷新订单列表
              updatecardData();
              loadAllOrders();

              // 更新操作按钮
              const actionButtons = document.getElementById("actionButtons");
              actionButtons.innerHTML = "";
              const tradeButton = document.createElement("button");
              tradeButton.className = "modal-btn";
              tradeButton.style.background =
                "linear-gradient(to right, var(--energy-green), #27ae60)";
              tradeButton.style.marginRight = "10px";
              tradeButton.innerHTML =
                '<i class="fas fa-exchange-alt"></i> 交易';
              tradeButton.onclick = () => tradeOrder(orderId);
              actionButtons.appendChild(tradeButton);
          })
          .catch((error) => {
            console.error("匹配失败:", error);
            actionButtons.innerHTML =
              '<div class="error-message">匹配失败，请重试</div>';
          });
      }

      // 交易订单函数
      function tradeOrder(orderId) {
        const actionButtons = document.getElementById("actionButtons");
        actionButtons.innerHTML =
          '<button class="modal-btn" style="background: linear-gradient(to right, var(--energy-green), #27ae60); margin-right: 10px;"><i class="fas fa-spinner fa-spin"></i> 交易中...</button>';

        fetch(`${API_BASE_URL}/settleorder/${orderId}`)
          .then((response) => response.json())
          .then((data) => {
              // 更新UI显示交易完成
              const statusBadge = document.querySelector(
                ".modal-text .status-badge"
              );
              if (statusBadge) {
                statusBadge.textContent = "已完成";
                statusBadge.className = "status-badge status-finished";
              }

              // 刷新订单列表
              updatecardData();
              loadAllOrders();

              // 移除操作按钮
              const actionButtons = document.getElementById("actionButtons");
              actionButtons.innerHTML = "";
          })
          .catch((error) => {
            console.error("交易失败:", error);
            actionButtons.innerHTML =
              '<div class="error-message">交易失败，请重试</div>';
          });
      }

      // 关闭模态框
      function closeModal() {
        modal.classList.remove("active");
        setTimeout(() => {
          modal.style.display = "none";
        }, 300);
      }

      //更新仪表盘数据
      function updatecardData() {
        fetch(`${API_BASE_URL}/getsystemstatus`)
          .then((response) => response.json())
          .then((data) => {
            // 更新页面上的数据显示
            const energyPrice = parseFloat(data.energyprice).toFixed(2);
            document.getElementById(
              "energy-price"
            ).textContent = `¥${energyPrice}`;
            document.getElementById("active-orders").textContent =
              data.ordernum;
            document.getElementById("active-users").textContent = data.usernum;

            // 更新创建订单页面的能源价格
            document.getElementById("order-price").value = energyPrice;
            document.getElementById(
              "market-price-indicator"
            ).textContent = `市场价: ¥${energyPrice}`;

            // 更新订单详情计算
            updateOrderDetails();
          })
          .catch((error) => console.error("获取数据失败:", error));

        fetch(`${API_BASE_URL}/listneworders`)
          .then((response) => response.json())
          .then((data) => {
            const ordersTable = document.getElementById("orders-table");
            // 清空表格
            ordersTable.innerHTML = "";

            // 遍历数据并动态生成表格行
            data.forEach((order) => {
              const statusMap = {
                CREATED: { text: "已创建", class: "status-created" },
                MATCHED: { text: "已匹配", class: "status-matched" },
                FINISHED: { text: "已完成", class: "status-finished" },
              };
              const row = document.createElement("tr");

              // 创建每一列的数据
              const orderIdCell = document.createElement("td");
              orderIdCell.textContent = order.orderid;

              const quantityCell = document.createElement("td");
              quantityCell.textContent = order.amount;

              const statusCell = document.createElement("td");
              const statusBadge = document.createElement("span");
              // 获取状态信息
              const statusInfo = statusMap[order.status] || {
                text: order.status,
                class: "status-created",
              };

              // 创建状态标签
              statusBadge.classList.add("status-badge", statusInfo.class);
              statusBadge.textContent = statusInfo.text;
              statusCell.appendChild(statusBadge);

              const actionCell = document.createElement("td");
              const viewButton = document.createElement("button");
              viewButton.classList.add("btn", "btn-sm", "btn-outline-primary");
              viewButton.textContent = "查看";
              viewButton.setAttribute("data-order-id", order.orderid); // 确保设置正确的属性
              actionCell.appendChild(viewButton);

              // 将所有列添加到行
              row.appendChild(orderIdCell);
              row.appendChild(quantityCell);
              row.appendChild(statusCell);
              row.appendChild(actionCell);

              // 将行添加到表格的tbody中
              ordersTable.appendChild(row);
              // 事件委托：处理仪表盘中动态生成的查看按钮
              document
                .getElementById("dashboard-section")
                .addEventListener("click", function (event) {
                  const button = event.target.closest("button[data-order-id]");
                  if (button) {
                    const orderId = button.getAttribute("data-order-id");
                    showOrderDetail(orderId);
                  }
                });
            });
          })
          .catch((error) => console.error("获取订单数据失败:", error));
      }

      // 更新订单详情计算
      function updateOrderDetails() {
        const amount = parseInt(document.getElementById("order-amount").value);
        const price = parseFloat(document.getElementById("order-price").value);
        const fee = (amount * price * 0.01).toFixed(2);
        const total = (amount * price).toFixed(2);
        const profit = (amount * price - fee).toFixed(2);

        document.getElementById(
          "order-price-display"
        ).textContent = `¥${price.toFixed(2)}`;
        document.getElementById("order-fee").textContent = `¥${fee}`;
        document.getElementById("order-total").textContent = `¥${total}`;
        document.getElementById("order-profit").textContent = `¥${profit}`;
      }

      // 显示指定标签页
      function showTab(tabId) {
        // 隐藏所有标签页
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        // 显示目标标签页
        document.getElementById(`${tabId}-section`).classList.add("active");
      }

      // 初始化图表
      function initCharts() {
        // 价格趋势图
        const priceCtx = document
          .getElementById("price-chart")
          .getContext("2d");
        new Chart(priceCtx, {
          type: "line",
          data: {
            labels: ["周一", "周二", "周三", "周四", "周五", "周六", "周日"],
            datasets: [
              {
                label: "能源价格 (¥/kWh)",
                data: [1.18, 1.22, 1.25, 1.28, 1.3, 1.25, 1.23],
                borderColor: "#4361ee",
                backgroundColor: "rgba(67, 97, 238, 0.1)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "最近7天能源价格趋势",
              },
            },
          },
        });

        // 能源类型分布图
        const typeCtx = document
          .getElementById("energy-type-chart")
          .getContext("2d");
        new Chart(typeCtx, {
          type: "doughnut",
          data: {
            labels: ["太阳能", "风能", "水能", "生物质能", "其他"],
            datasets: [
              {
                label: "能源类型分布",
                data: [45, 25, 15, 10, 5],
                backgroundColor: [
                  "#4361ee",
                  "#4cc9f0",
                  "#2ecc71",
                  "#f39c12",
                  "#e74c3c",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "right",
              },
              title: {
                display: true,
                text: "能源类型分布比例",
              },
            },
          },
        });
      }

      // 创建订单
      function createOrder() {
        const amount = document.getElementById("order-amount").value;
        const price = document.getElementById("order-price").value;
        const isSell = true; // 现在只支持出售能源

        if (!amount || amount < 1) {
          alert("请输入有效的能源数量");
          return;
        }

        // 显示加载效果
        const createBtn = document.getElementById("create-order-btn");
        const originalHtml = createBtn.innerHTML;
        createBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> 创建中...';
        createBtn.disabled = true;

        // 模拟API调用
        setTimeout(() => {
          fetch(`${API_BASE_URL}/createorder/${amount}`)
            .then((response) => response.json())
            .then((data) => {
              alert(
                `出售订单创建成功！\n数量: ${amount} kWh\n价格: ¥${price}/kWh`
              );
            })
            .catch(function (error) {
              modalText.innerHTML = `<div class="error-message">请求失败，请稍后再试。</div>`;
              console.error("创建订单失败:", error);
            });

          // 重置按钮
          createBtn.innerHTML = originalHtml;
          createBtn.disabled = false;

          // 重置表单
          document.getElementById("order-amount").value = 100;
          document.getElementById("order-amount-range").value = 100;
          updateOrderDetails();
        }, 1500);
      }

      // 刷新系统状态
      function refreshSystem() {
        const refreshBtn = document.getElementById("refresh-system-btn");
        const originalHtml = refreshBtn.innerHTML;
        refreshBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> 刷新中...';
        refreshBtn.disabled = true;

        // 模拟刷新
        setTimeout(() => {
          // 更新数据
          document.getElementById("available-energy").textContent =
            "1,320.8 kWh";
          document.getElementById("active-orders").textContent = "26";
          document.getElementById("active-users").textContent = "19";
          document.getElementById("energy-price").textContent = "¥1.28";

          // 重置按钮
          refreshBtn.innerHTML = originalHtml;
          refreshBtn.disabled = false;

          alert("系统状态已刷新！");
        }, 1000);
      }

      // 加载所有订单
      function loadAllOrders() {
        const refreshBtn = document.getElementById("refresh-orders-btn");
        const originalHtml = refreshBtn.innerHTML;
        refreshBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> 加载中...';
        refreshBtn.disabled = true;

        // 模拟加载
        setTimeout(() => {
          // 这里可以添加实际加载订单的逻辑
          let choiceStatus = document.getElementById(
            "order-status-filter"
          ).value;
          let choiceType = document.getElementById("order-type-filter").value;
          fetch(`${API_BASE_URL}/getallorders/${choiceStatus}/${choiceType}`)
            .then((response) => response.json())
            .then((data) => {
              const ordersTable = document.getElementById("all-orders-table");
              // 清空表格
              ordersTable.innerHTML = "";

              // 遍历数据并动态生成表格行
              data.forEach((order) => {
                const statusMap = {
                  CREATED: { text: "已创建", class: "status-created" },
                  MATCHED: { text: "已匹配", class: "status-matched" },
                  FINISHED: { text: "已完成", class: "status-finished" },
                };
                const row = document.createElement("tr");

                // 创建每一列的数据
                const orderIdCell = document.createElement("td");
                orderIdCell.textContent = order.orderid;

                const quantityCell = document.createElement("td");
                quantityCell.textContent = order.amount;

                const statusCell = document.createElement("td");
                const statusBadge = document.createElement("span");
                const statusInfo = statusMap[order.status] || {
                  text: order.status,
                  class: "status-created",
                };

                // 创建状态标签
                statusBadge.classList.add("status-badge", statusInfo.class);
                statusBadge.textContent = statusInfo.text;
                statusCell.appendChild(statusBadge);

                const actionCell = document.createElement("td");
                const viewButton = document.createElement("button");
                viewButton.classList.add(
                  "btn",
                  "btn-sm",
                  "btn-outline-primary"
                );
                viewButton.textContent = "查看";
                viewButton.setAttribute("data-order-id", order.orderid); // 确保设置正确的属性
                actionCell.appendChild(viewButton);

                // 将所有列添加到行
                row.appendChild(orderIdCell);
                row.appendChild(quantityCell);
                row.appendChild(statusCell);
                row.appendChild(actionCell);

                // 将行添加到表格的tbody中
                ordersTable.appendChild(row);
                document
                  .getElementById("orders-section")
                  .addEventListener("click", function (event) {
                    const button = event.target.closest(
                      "button[data-order-id]"
                    );
                    if (button) {
                      const orderId = button.getAttribute("data-order-id");
                      showOrderDetail(orderId);
                    }
                  });
              });
            })
            .catch((error) => console.error("获取订单数据失败:", error));

          // 重置按钮
          refreshBtn.innerHTML = originalHtml;
          refreshBtn.disabled = false;

          //alert("订单列表已刷新！");
        }, 800);
      }
    </script>
  </body>
</html>
